# Copyright (C) 2020 Nicolas Lamirault <nicolas.lamirault@gmail.com>

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: e2e

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  kind:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      # - name: Unlock secrets
      #   uses: sliteteam/github-action-git-crypt-unlock@1.0.2
      #   env:
      #     GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
      - name: Setup Kubernetes
        uses: engineerd/setup-kind@v0.5.0
        with:
          # version: "v0.9.0"  # Kind version
          image: kindest/node:v1.16.9
      - name: Check kubernetes
        run: |
          kubectl cluster-info
          kubectl get pods -n kube-system
          echo "current-context:" $(kubectl config current-context)
          echo "environment-kubeconfig:" ${KUBECONFIG}
      - name: Flux
        run: |
          wget https://github.com/fluxcd/flux2/releases/download/v0.2.6/flux_0.2.6_linux_amd64.tar.gz
          sudo tar zxvf flux_0.2.6_linux_amd64.tar.gz -C /usr/local/bin
          flux -v
      - name: Flux bootstrap
        run: |
          export GOTK_VERSION="v0.2.1"
          username=$(echo "${GITHUB_REPOSITORY}" | awk -F"/" '{ print $1 }')
          echo ${username}
          repository=$(echo "${GITHUB_REPOSITORY}" | awk -F"/" '{ print $2 }')
          echo ${repository}
          flux bootstrap github \
            --components=source-controller,kustomize-controller,helm-controller,notification-controller \
            --path=clusters/local/dev \
            --version=${GOTK_VERSION} \
            --owner=${username} \
            --repository=${repository} \
            --branch=master \
            --personal
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # - name: flux check --pre
      #   run: |
      #     ./bin/flux check --pre
      # - name: flux install --manifests
      #   run: |
      #     ./bin/flux install --manifests ./manifests/install/
      # - name: flux create source git
      #   run: |
      #     ./bin/flux create source git podinfo \
      #       --url https://github.com/stefanprodan/podinfo  \
      #       --tag-semver=">=3.2.3"
      # - name: flux create source git export apply
      #   run: |
      #     ./bin/flux create source git podinfo-export \
      #       --url https://github.com/stefanprodan/podinfo  \
      #       --tag-semver=">=3.2.3" \
      #       --export | kubectl apply -f -