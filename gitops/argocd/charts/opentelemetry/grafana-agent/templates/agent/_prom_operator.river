{{ define "agent.config.prom_operator" }}

// ********************************************
// * P R O M E T H E U S  O P E R A T O R
// ********************************************

// ServiceMonitor

prometheus.operator.servicemonitors "service_monitors" {
  forward_to = [
    prometheus.remote_write.local.receiver,
    // prometheus.remote_write.grafana_cloud.receiver,
  ]

  selector {
    match_expression {
        key = "monitoring"
        operator = "In"
        values = ["portefaix"]
    }
  }
}

// PodMonitor

prometheus.operator.podmonitors "pod_monitors" {
  forward_to = [
    prometheus.remote_write.local.receiver,
    // prometheus.remote_write.grafana_cloud.receiver,
  ]

  selector {
    match_expression {
        key = "monitoring"
        operator = "In"
        values = ["portefaix"]
    }
  }
}

// PrometheusRule

mimir.rules.kubernetes "prometheus_rules" {
  address = {{ .Values.observability.metrics.prometheus | quote }}

  rule_selector {
    match_labels = {
      monitoring = "portefaix",
    }
  }
}

{{ end }}
